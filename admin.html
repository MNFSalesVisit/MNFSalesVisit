<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - Sales Visit App</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{ font-family: "Segoe UI", system-ui, -apple-system, Arial; padding:12px; background:#f8f9fa; }
  .card { border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
  #map { height: 420px; border-radius:10px; }
  .small-muted { color:#666; font-size:13px; }
  .table-fixed tbody{ max-height:240px; overflow:auto; display:block; }
  .table-fixed thead, .table-fixed tbody tr { display:table; width:100%; table-layout:fixed; }
  .table-fixed thead { width:100%; }
</style>
</head>
<body>

<div class="d-flex align-items-center mb-3">
  <h4 class="me-3">Admin Dashboard</h4>
  <div class="ms-auto">
    <button class="btn btn-outline-secondary" onclick="goBack()">Back</button>
    <button class="btn btn-danger ms-2" onclick="logout()">Logout</button>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-4">
    <div class="card p-3">
      <label class="small-muted">Select Year</label>
      <select id="yearSel" class="form-select"></select>

      <label class="small-muted mt-2">Select Month</label>
      <select id="monthSel" class="form-select">
        <option value="">All</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
        <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
        <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
      </select>

      <label class="small-muted mt-2">Period Type</label>
      <select id="typeSel" class="form-select">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly" selected>Monthly</option>
      </select>

      <div class="d-grid mt-3">
        <button class="btn btn-primary" onclick="loadSummary()">Load Summary</button>
        <button class="btn btn-outline-secondary mt-2" onclick="exportCSV()">Export Visits (CSV)</button>
      </div>
    </div>

    <div class="card p-3 mt-3">
      <h6>Quick totals</h6>
      <div class="small-muted">Visits: <strong id="totalVisits">0</strong></div>
      <div class="small-muted">Sold: <strong id="totalSold">0</strong></div>
      <div class="small-muted">Cartons: <strong id="totalCartons">0</strong></div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card p-3 mb-3">
      <h6>Map view</h6>
      <div id="map"></div>
    </div>

    <div class="card p-3 mb-3">
      <h6>By User</h6>
      <div style="max-height:260px; overflow:auto;">
        <table class="table">
          <thead>
            <tr><th>User</th><th>Visits</th><th>Sold</th><th>Cartons</th><th>Efficiency</th></tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card p-3">
      <h6>By Region</h6>
      <div style="max-height:220px; overflow:auto;">
        <table class="table">
          <thead>
            <tr><th>Region</th><th>Visits</th><th>Sold</th><th>Cartons</th><th>Efficiency</th></tr>
          </thead>
          <tbody id="regionsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- selfie modal -->
<div class="modal fade" id="selfieModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Selfie & Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="selfieBody" style="text-align:center"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const DEFAULT_BACKEND = "https://script.google.com/macros/s/AKfycbxPuK8Vwl30zuyrutpLZfu81LYjPzPMUPCFBNxWzL-w5grgcx0vDtMBp9l5WJRuj2cC/exec";
const backend = localStorage.getItem("backendURL") || DEFAULT_BACKEND;

let currentUser = null;
let map, markersLayer;
let allVisits = [];

/* auth check */
window.onload = async () => {
  const s = localStorage.getItem("userSession");
  if(!s){
    alert("Not logged in.");
    return window.location = "index.html";
  }
  currentUser = JSON.parse(s);
  if(!currentUser.role || currentUser.role.toLowerCase() !== "admin"){
    document.body.innerHTML = "<div class='p-4'><h4>Unauthorized</h4><p>This page is for admins only.</p><a href='index.html'>Back to login</a></div>";
    return;
  }

  // populate years
  const now = new Date();
  const yearSel = document.getElementById("yearSel");
  for(let y = now.getFullYear(); y >= now.getFullYear()-3; y--){
    const opt = document.createElement("option"); opt.value = y; opt.textContent = y;
    if(y === now.getFullYear()) opt.selected = true;
    yearSel.appendChild(opt);
  }

  initMap();
  await fetchAllVisits();
  loadSummary();
};

/* Map init */
function initMap(){
  map = L.map('map').setView([ -1.286389, 36.817223 ], 11); // Nairobi center by default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

/* fetch all visits */
async function fetchAllVisits(){
  try{
    const r = await fetch(backend, { method:"POST", body: JSON.stringify({ action:"getAllVisits" }) });
    allVisits = await r.json();
  }catch(err){
    console.error(err);
    allVisits = [];
  }
}

/* load summary */
async function loadSummary(){
  const type = document.getElementById("typeSel").value;
  const month = document.getElementById("monthSel").value;
  const year = document.getElementById("yearSel").value;

  const params = { type, month: month ? Number(month) : null, year: Number(year) };
  const r = await fetch(backend, { method:"POST", body: JSON.stringify({ action:"adminSummary", params }) });
  const d = await r.json();

  // populate quick totals
  let totalVisits = 0, totalSold = 0, totalCartons = 0;
  d.users.forEach(u => { totalVisits += u.visits; totalSold += u.sold; totalCartons += u.cartons; });

  document.getElementById("totalVisits").textContent = totalVisits;
  document.getElementById("totalSold").textContent = totalSold;
  document.getElementById("totalCartons").textContent = totalCartons;

  // populate tables
  const usersTable = document.getElementById("usersTable");
  usersTable.innerHTML = "";
  d.users.sort((a,b)=> b.visits - a.visits).forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${u.name || u.nationalID}</td><td>${u.visits}</td><td>${u.sold}</td><td>${u.cartons}</td><td>${u.efficiency}%</td>`;
    usersTable.appendChild(tr);
  });

  const regionsTable = document.getElementById("regionsTable");
  regionsTable.innerHTML = "";
  d.regions.sort((a,b)=> b.visits - a.visits).forEach(rg=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${rg.region}</td><td>${rg.visits}</td><td>${rg.sold}</td><td>${rg.cartons}</td><td>${rg.efficiency}%</td>`;
    regionsTable.appendChild(tr);
  });

  // map markers from allVisits filtered by month/year
  populateMap(month ? Number(month) : null, Number(year));
}

/* populate map */
function populateMap(month, year){
  markersLayer.clearLayers();
  const filtered = allVisits.filter(v => {
    if(!v.timestamp) return false;
    const d = new Date(v.timestamp);
    if(month){
      return (d.getMonth()+1) === month && d.getFullYear() === year;
    }
    return true;
  });

  filtered.forEach((v,i)=>{
    const lat = Number(v.latitude);
    const lng = Number(v.longitude);
    if(!lat || !lng) return;
    const marker = L.marker([lat,lng]).addTo(markersLayer);
    const content = buildPopupHtml(v);
    marker.bindPopup(content);
  });

  if(markersLayer.getLayers().length > 0){
    map.fitBounds(markersLayer.getBounds(), { padding:[40,40] });
  }
}

function buildPopupHtml(v){
  const time = new Date(v.timestamp).toLocaleString();
  const selfieHtml = v.selfie ? `<img src="${v.selfie}" style="width:160px;border-radius:8px;display:block;margin:6px auto;">` : '';
  return `<div style="min-width:180px">
    <strong>${v.name || v.nationalID}</strong><br>
    <small>${v.shopName || ''}</small><br>
    <small>${v.region || ''}</small><br>
    <small>${time}</small>
    ${selfieHtml}
    <div style="text-align:center;margin-top:6px">
      <button class="btn btn-sm btn-outline-primary" onclick="showSelfie('${escapeHtml(JSON.stringify(v).replace(/'/g,'\\\''))}')">View Details</button>
    </div>
  </div>`;
}

/* show selfie modal */
function showSelfie(jsonStr){
  try{
    const v = JSON.parse(unescapeHtml(jsonStr));
    const body = document.getElementById("selfieBody");
    body.innerHTML = `
      ${v.selfie ? `<img src="${v.selfie}" style="max-width:100%;border-radius:10px;margin-bottom:8px;">` : '<div class="small-muted">No selfie</div>'}
      <div><strong>${v.name || v.nationalID}</strong></div>
      <div class="small-muted">${v.shopName || ''} â€” ${v.region || ''}</div>
      <div class="small-muted">Sold: ${v.sold}</div>
      <div class="small-muted">Cartons: ${v.totalCartons || 0}</div>
    `;
    const modal = new bootstrap.Modal(document.getElementById("selfieModal"), {});
    modal.show();
  }catch(e){
    console.error(e);
  }
}

/* export CSV */
async function exportCSV(){
  // We'll export allVisits as CSV client-side
  if(!allVisits || allVisits.length === 0){ alert("No visits to export"); return; }
  const headers = ["timestamp","nationalID","name","region","shopName","sold","skus","totalCartons","reason","longitude","latitude"];
  const rows = [headers.join(",")];
  allVisits.forEach(v=>{
    const row = [
      v.timestamp ? new Date(v.timestamp).toISOString() : "",
      csvSafe(v.nationalID),
      csvSafe(v.name),
      csvSafe(v.region),
      csvSafe(v.shopName),
      csvSafe(v.sold),
      csvSafe(v.skus),
      csvSafe(String(v.totalCartons || 0)),
      csvSafe(v.reason),
      csvSafe(String(v.longitude || "")),
      csvSafe(String(v.latitude || ""))
    ];
    rows.push(row.join(","));
  });
  const blob = new Blob([rows.join("\n")], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `visits_export_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* helpers */
function csvSafe(v){
  if(v === null || v === undefined) return "";
  const s = String(v).replace(/"/g, '""');
  if(s.includes(",") || s.includes("\n")) return `"${s}"`;
  return s;
}

function escapeHtml(s){
  return encodeURIComponent(s);
}
function unescapeHtml(s){
  return decodeURIComponent(s);
}

function goBack(){ window.location = "index.html"; }
function logout(){
  localStorage.removeItem("userSession");
  window.location = "index.html";
}

/* utility to load all visits initially */
(async function initAll(){
  try{
    const r = await fetch(backend, { method:"POST", body: JSON.stringify({ action:"getAllVisits" }) });
    allVisits = await r.json();
  }catch(e){ allVisits = []; }
})();

</script>
</body>
</html>
